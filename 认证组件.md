# 一、认证(Authentication)
认证，校验登录状态

## 1.1 Authentication源码分析
认证是在`APIView`类种的`dispatch`方法中认证的`self.initial(request, *args, **kwargs)`方法中进行认证的

```python
def initial(self, request, *args, **kwargs):
    # Ensure that the incoming request is permitted
    self.perform_authentication(request)  # 认证
    self.check_permissions(request)  # 权限
    self.check_throttles(request)  # 频率
```
下面看`self.perform_authentication(request)`方法的源码
```python
def perform_authentication(self, request):
    request.user  # 在drf封装的request对象中
```
在Request类种查找`user`属性或方法查看认证原理
```python
def user(self):
    if not hasattr(self, '_user'):  # 判断request中是否有_user属性
        with wrap_attributeerrors():
            self._authenticate()  # 没有，执行此方法
    return self._user  # 有，返回用户
```
查看`Request`类种的`_authenticate()`方法(核心认证方法)
```python
def _authenticate(self):
    for authenticator in self.authenticators:  # self.authenticators = authenticators or () 是在Request类实例化是传入的认证类的对象。没次循环都会拿到一个认证类的对象
        try:
            user_auth_tuple = authenticator.authenticate(self)  # 认证对象的authenticate方法。该方法要返回两个值
        except exceptions.APIException:  # 认证失败，抛出异常
            self._not_authenticated()
            raise

        # 返回值的处理
        if user_auth_tuple is not None:
            self._authenticator = authenticator
            self.user, self.auth = user_auth_tuple  # self是Request的对象
            return

    self._not_authenticated()  # 没有返回值，代表游客认证通过
```

* `self.authenticators`是Request类实例化是传入的。而Request类是在`APIView`的`dispatch`方法中实例化的。
    ```python
    request = self.initialize_request(request, *args, **kwargs)  # Request类的实例化
    ```
    查看`initialize_request`方法
    ```python
    
    def initialize_request(self, request, *args, **kwargs):
        parser_context = self.get_parser_context(request)
    
        return Request(
            request,
            parsers=self.get_parsers(),
            authenticators=self.get_authenticators(),  # 认证类的对象
            negotiator=self.get_content_negotiator(),
            parser_context=parser_context
        )
    ```
    查看`get_authenticators`方法
    ```python
    def get_authenticators(self):
        # 返回的是认证类的对象
        return [auth() for auth in self.authentication_classes]
    ```
    `self.authentication_classes`是视图类的属性, 在`APIView`类属性中也有。对于继承了`APIView`中子类，都可以重写此属性。它是一个可迭代对象。
    

## 1.2 Authentication实现
* 第一步，写一个认证类，继承BaseAuthentication类
* 第二步，重写authenticate方法，里面是认证逻辑
    * 认证通过，返回两个值，被Request类的对象user属性和auth属性接受
    * 认证失败，抛出异常，`APIException`或`AuthenticationFailed`异常，其中`AuthenticationFailed`异常是继承`APIException`
* 第三步，在视图类重写`authentication_classes`属性，此属性是一个列表，保存的是认证类

```python

```



# 二、权限(Permissions)



# 三、频率(Throttling)